rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Locations collection
    match /locations/{locationId} {
      // Anyone can read locations
      allow read: if true;

      // No client-side location creation
      allow create: if false;

      // Only allow updates to aggregation fields (from Cloud Functions or client aggregation)
      allow update: if isAggregationUpdate(request.resource.data, resource.data);

      // No deletes from clients
      allow delete: if false;

      // Ratings subcollection
      match /ratings/{ratingId} {
        // Anyone can read ratings
        allow read: if true;

        // Require auth; userId must match the authenticated user
        allow create: if request.auth != null
                       && request.resource.data.userId == request.auth.uid
                       && isValidRating(request.resource.data);

        // Allow updating only your own rating (userId must not change)
        allow update: if request.auth != null
                       && resource.data.userId == request.auth.uid
                       && request.resource.data.userId == resource.data.userId
                       && isValidRating(request.resource.data);

        // No deletes from clients
        allow delete: if false;
      }
    }

    // Helper: only allow updating aggregation fields, not core location data
    function isAggregationUpdate(newData, oldData) {
      return newData.name == oldData.name
        && newData.category == oldData.category
        && newData.city == oldData.city
        && newData.coordinates == oldData.coordinates;
    }

    // Helper: validate rating document structure (supports new phase-based schema)
    function isValidRating(data) {
      return data.keys().hasAll(['userId', 'ageGroup', 'phase', 'timestamp'])
        && data.userId is string
        && data.userId.size() > 0
        && data.userId.size() <= 128
        && data.ageGroup is string
        && data.ageGroup in ['18-22', '23-28', '29-35', '36+']
        && data.phase is string
        && data.phase in ['checkin', 'reviewed'];
    }

    // Deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
